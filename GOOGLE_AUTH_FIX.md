# Google Authentication - User Data Not Persisting Fix

## ğŸ” Problem Identified

When users sign in with Google authentication, their game statistics (wins, losses, games played) are **NOT being preserved** between sessions. Each login appears to create a "new user" even though they're using the same Google account.

## ğŸ¯ Root Cause

After analyzing your Firestore database screenshot, there are **TWO possible causes**:

### Cause 1: Firestore Security Rules (Most Likely)
Your Firestore security rules might be **blocking read access** to user documents. When the app tries to check if a user already exists, it gets a permission denied error, so it creates a new user instead.

### Cause 2: Multiple Google Accounts
You might be testing with different Google accounts, which would generate different Firebase UIDs.

## âœ… Solution

### Step 1: Update Firestore Security Rules

Go to your Firebase Console and update your Firestore security rules:

1. Open [Firebase Console](https://console.firebase.google.com/)
2. Select your project: `migoyugo-e248a`
3. Go to **Firestore Database** â†’ **Rules**
4. Replace with these rules:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection rules
    match /users/{userId} {
      // Allow users to read and write their own document
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow any authenticated user to read user documents (needed for leaderboard)
      allow read: if request.auth != null;
      
      // Allow creating new user documents
      allow create: if request.auth != null;
    }
    
    // Add other collection rules as needed
  }
}
```

5. Click **Publish**

### Step 2: Test the Fix

1. **Clear your existing test data** (optional but recommended):
   - Go to Firestore Database
   - Delete all documents in the `users` collection
   
2. **Test Google Sign-in**:
   - Open your app
   - Sign in with Google
   - Open browser DevTools console (F12)
   - Look for these log messages:

```
ğŸ”µ Starting Google sign-in...
ğŸ”µ Google sign-in successful! User UID: <YOUR_UID>
ğŸ“ createOrUpdateUser called with user: { uid, email, displayName }
ğŸ“ Looking for existing user document at path: users/<YOUR_UID>
ğŸ“ getDoc completed. Document exists: false
ğŸ†• No existing user found, creating new user document
âœ… New user document created successfully
```

3. **Play a game and win** (to get some stats)

4. **Sign out and sign back in with Google**:
   - You should now see:

```
ğŸ”µ Starting Google sign-in...
ğŸ”µ Google sign-in successful! User UID: <SAME_UID>
ğŸ“ createOrUpdateUser called with user: { uid, email, displayName }
ğŸ“ Looking for existing user document at path: users/<SAME_UID>
ğŸ“ getDoc completed. Document exists: true
âœ… Existing user found! Stats: { totalGames: 1, wins: 1, losses: 0, draws: 0 }
âœ… User login info updated successfully
```

5. **Verify in Firestore**:
   - Check the `users` collection
   - You should see ONE document with your UID as the document ID
   - The stats should be preserved

## ğŸ› If Still Not Working

### Check Console for Errors

If you see this error:
```
âŒ Error reading user document (might be permissions): FirebaseError: Missing or insufficient permissions
```

**Solution**: Your Firestore security rules are still blocking access. Double-check Step 1 above.

### Verify Same Google Account

1. Note your UID from the console logs on first login
2. Sign out and sign back in
3. Check if the UID is the same
4. If different â†’ You're using different Google accounts

### Check Firebase Authentication Settings

1. Go to Firebase Console â†’ Authentication â†’ Sign-in method
2. Ensure **Google** is enabled
3. Check if there are any restrictions on authorized domains

## ğŸ“Š Expected Behavior After Fix

âœ… First Google sign-in: Creates new user with 0 stats
âœ… Win a game: Stats increment (wins: 1, games: 1)
âœ… Sign out and sign back in: **Stats are preserved** (wins: 1, games: 1)
âœ… Win another game: Stats increment again (wins: 2, games: 2)

## ğŸ”§ Code Changes Made

The following files have been updated with better error handling and logging:

1. **authService.ts**: Added detailed logging for Google sign-in
2. **firestoreService.ts**: 
   - Fixed `createOrUpdateUser` to check if user exists before creating
   - Added comprehensive error handling for permission issues
   - Preserves all existing stats when user logs in again

## ğŸ“ Notes

- The UID is generated by Firebase Authentication and is **unique per Google account**
- The same Google account will always have the same UID
- User stats are stored in Firestore at path: `users/{uid}`
- The document ID IS the user's UID (not auto-generated)

## ğŸ”¬ Quick Diagnostic Script

Run this in your browser console (F12) after signing in with Google:

```javascript
(async function diagnostics() {
  console.log('ğŸ”¬ Running diagnostics...');
  
  // Check Firebase Auth
  const { auth } = await import('./firebase');
  const currentUser = auth.currentUser;
  
  if (!currentUser) {
    console.error('âŒ No user signed in!');
    return;
  }
  
  console.log('âœ… Firebase Auth User:', {
    uid: currentUser.uid,
    email: currentUser.email,
    displayName: currentUser.displayName
  });
  
  // Check Firestore access
  const { db } = await import('./firebase');
  const { doc, getDoc } = await import('firebase/firestore');
  
  try {
    const userRef = doc(db, 'users', currentUser.uid);
    const userSnap = await getDoc(userRef);
    
    if (userSnap.exists()) {
      console.log('âœ… Firestore user document found:', userSnap.data());
    } else {
      console.warn('âš ï¸ User document does NOT exist in Firestore');
    }
  } catch (error) {
    console.error('âŒ Error accessing Firestore:', error);
    console.error('âŒ This is likely a security rules issue!');
  }
})();
```

This will show you:
- âœ… If you're signed in to Firebase Auth
- âœ… Your UID (compare this between logins to verify same account)
- âœ… If your Firestore document exists
- âœ… Your current stats from Firestore
- âŒ Any permission errors 